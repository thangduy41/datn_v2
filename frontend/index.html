<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tìm Kiếm Địa Điểm Du Lịch</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header class="search-header">
            <h1>Tìm Kiếm Địa Điểm Du Lịch</h1>
            <div class="search-form">
                <input type="text" id="searchInput" placeholder="Nhập từ khóa, ví dụ: biển đẹp ở Đà Nẵng...">
                <button onclick="performSearch()">Tìm kiếm</button> 
            </div>
        </header>

        <main class="content-area">
            <section id="queryDetailsSection" class="query-details-section">
                <div id="queryDetails"></div>
            </section>

            <section id="resultsSection" class="results-section">
                <div id="results">
                    <p class="no-results-placeholder">Nhập từ khóa và nhấn tìm kiếm để xem kết quả.</p>
                </div>
            </section>

            <div id="errorMessage" class="error-message">
            </div>
        </main>
    </div>

    <script>
        const API_BASE_URL = "http://127.0.0.1:5000/api/v1";

        // HÀM TIỆN ÍCH ĐỂ CHUYỂN SANG TITLE CASE
        function toTitleCase(str) {
            if (!str || typeof str !== 'string') { // Kiểm tra null, undefined, và không phải string
                return ""; // Trả về chuỗi rỗng nếu không hợp lệ
            }
            return str.toLowerCase().replace(/\b(\w)/g, s => s.toUpperCase());
        }

        async function performSearch() {
            const query = document.getElementById('searchInput').value;
            const resultsDiv = document.getElementById('results');
            const queryDetailsDiv = document.getElementById('queryDetails');
            const errorMessageDiv = document.getElementById('errorMessage');

            resultsDiv.innerHTML = '<p class="loading-placeholder">Đang tìm kiếm...</p>';
            queryDetailsDiv.innerHTML = '';
            errorMessageDiv.textContent = ''; 

            if (!query.trim()) {
                errorMessageDiv.textContent = "Vui lòng nhập từ khóa tìm kiếm.";
                resultsDiv.innerHTML = '<p class="no-results-placeholder">Vui lòng nhập từ khóa để bắt đầu.</p>';
                return;
            }

            console.log("Bắt đầu tìm kiếm với query:", query);

            try {
                const response = await fetch(`${API_BASE_URL}/search?query=${encodeURIComponent(query)}&limit=10`); // Bạn có thể đổi limit ở đây
                
                console.log("Trạng thái response từ API:", response.status); 

                if (!response.ok) {
                    let errorText = `Lỗi từ server: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorText = errorData.error || errorText;
                    } catch (e) {
                        errorText = await response.text(); 
                    }
                    throw new Error(errorText);
                }
                const data = await response.json();
                console.log("Dữ liệu nhận được từ API:", data); 
                displayResults(data);
            } catch (error) {
                console.error('Lỗi khi tìm kiếm:', error);
                errorMessageDiv.textContent = `Lỗi: ${error.message}`;
                resultsDiv.innerHTML = '<p class="no-results-placeholder error">Không thể tải kết quả. Vui lòng thử lại.</p>';
            }
        }

        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            const queryDetailsDiv = document.getElementById('queryDetails');
            resultsDiv.innerHTML = ''; 

            if (data.query_details) {
                let detailsHtml = "<h3>Thông tin truy vấn đã xử lý:</h3><ul class='query-info-list'>";
                detailsHtml += `<li><strong>Truy vấn gốc:</strong> ${data.query_details.original_query || "N/A"}</li>`;
                
                if (data.query_details.target_province && typeof data.query_details.target_province === 'string') {
                    const formattedProvince = toTitleCase(data.query_details.target_province.replace("_", " ")); // Sử dụng toTitleCase
                    detailsHtml += `<li><strong>Tỉnh/Thành ưu tiên:</strong> ${formattedProvince}</li>`;
                }

                if (data.query_details.applied_negations && data.query_details.applied_negations.length > 0) {
                    detailsHtml += `<li><strong>Từ khóa phủ định:</strong> ${data.query_details.applied_negations.join(', ')}</li>`;
                }
                 if (data.query_details.processed_for_tfidf) {
                    detailsHtml += `<li><strong>Từ khóa cho TF-IDF:</strong> ${data.query_details.processed_for_tfidf}</li>`;
                }
                detailsHtml += "</ul>";
                queryDetailsDiv.innerHTML = detailsHtml;
            } else {
                queryDetailsDiv.innerHTML = "";
            }

            let hasResults = false;
            if (data.province_results && data.province_results.locations && data.province_results.locations.length > 0) {
                hasResults = true;
                
                let provinceDisplayName = "Ưu tiên";
                if (data.province_results.province_name && typeof data.province_results.province_name === 'string') {
                    provinceDisplayName = toTitleCase(data.province_results.province_name); // Sử dụng toTitleCase
                } else if (data.query_details && data.query_details.target_province && typeof data.query_details.target_province === 'string') {
                     provinceDisplayName = toTitleCase(data.query_details.target_province.replace("_", " ")); // Sử dụng toTitleCase
                }
                
                let provinceHtml = `<h2 class="results-title">${data.province_results.title || `Các địa điểm tại ${provinceDisplayName}`}</h2><ul class="results-list">`;
                data.province_results.locations.forEach(location => {
                    const score = location.score !== undefined ? location.score.toFixed(4) : (location.tfidf_score !== undefined ? location.tfidf_score.toFixed(4) : 'N/A');
                    provinceHtml += `
                        <li class="result-item">
                            <a href="detail.html?id=${location.id_dia_diem}" target="_blank">${location.ten}</a> 
                            <span class="score">(Điểm: ${score})</span>
                            <p class="short-description">${location.mo_ta || ''}</p>
                        </li>`;
                });
                provinceHtml += '</ul>';
                resultsDiv.innerHTML += provinceHtml;
            }

            if (data.other_results && data.other_results.locations && data.other_results.locations.length > 0) {
                hasResults = true;
                let otherHtml = `<h2 class="results-title">${data.other_results.title || 'Các địa điểm tương tự'}</h2><ul class="results-list">`;
                data.other_results.locations.forEach(location => {
                    const score = location.score !== undefined ? location.score.toFixed(4) : (location.tfidf_score !== undefined ? location.tfidf_score.toFixed(4) : 'N/A');
                     otherHtml += `
                        <li class="result-item">
                            <a href="detail.html?id=${location.id_dia_diem}" target="_blank">${location.ten}</a>
                            <span class="score">(Điểm: ${score})</span>
                            <p class="short-description">${location.mo_ta || ''}</p>
                        </li>`;
                });
                otherHtml += '</ul>';
                resultsDiv.innerHTML += otherHtml;
            }

            if (!hasResults) { 
                 resultsDiv.innerHTML = `<p class="no-results-placeholder">${(data.other_results && data.other_results.title && data.other_results.title !== "Kết quả tìm kiếm" && data.other_results.title !=="Các địa điểm gợi ý") ? data.other_results.title : "Không tìm thấy địa điểm nào phù hợp."}</p>`;
            }
        }

        document.getElementById('searchInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        document.addEventListener('DOMContentLoaded', (event) => {
            if(!document.getElementById('results').hasChildNodes() || document.getElementById('results').innerHTML.trim() === ""){
                 document.getElementById('results').innerHTML = '<p class="no-results-placeholder">Nhập từ khóa và nhấn tìm kiếm để xem kết quả.</p>';
            }
        });
    </script>
</body>
</html>